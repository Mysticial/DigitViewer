/* yc_TextWriter_internals.h - .txt Writer Object
 * 
 * Author           : Alexander J. Yee
 * Date Created     : 07/26/2013
 * Last Modified    : 07/26/2013
 * 
 */

#pragma once
#ifndef _yc_TextWriter_internals_H
#define _yc_TextWriter_internals_H
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  Dependencies
#include "yc_TextWriter_headers.h"
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
namespace DigitViewer{
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  Constructors
TextWriter::TextWriter(
    const std::wstring &path,
    const std::string &first_digits,
    bool raw,
    int radix
)
    : fp_convert(NULL)
{
    //  Create the file
    ym_file_create(NULL,&file,0,path.c_str());

    //  Write the first digits.
    if (first_digits.size() != 0){
        ym_pL decimal_offset = first_digits.find('.');
        if (decimal_offset == std::string::npos)
            throw ym_exception("No decimal place was found.",YCR_DIO_ERROR_INVALID_PARAMETERS);
        ym_file_wr(&file,first_digits.c_str(),decimal_offset + 1);
    }

    if (raw){
        switch (radix){
            case 10:
                fp_convert = ymb_CVN_rawd_to_strd_f;
                break;
            case 16:
                fp_convert = ymb_CVN_rawh_to_strh_f;
                break;
            default:
                throw ym_exception("Unsupported Radix",YCR_DIO_ERROR_INVALID_BASE);
        }
    }
}
TextWriter::~TextWriter(){
    flush();
    ym_file_close(&file);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void TextWriter::write(char *str,ym_pL digits){
    //  If the buffer isn't empty and "str" isn't the buffer itself, then we
    //  must flush the buffer first.
    if (iter_b_offset != 0 && str != buffer){
        flush();
    }

    //  If the input isn't raw, convert it.
    if (fp_convert != NULL)
        fp_convert(str,digits);

    //  Write to disk.
    if (ym_file_wr(&file,str,digits) != digits){
        throw ym_exception(
            "Error writing to file.",
            std::wstring(file.path),
            ym_file_get_error_code()
        );
    }
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
}
#endif
