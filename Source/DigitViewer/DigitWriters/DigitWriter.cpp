/* DigitWriter.cpp - File Writer Object Interface
 * 
 * Author           : Alexander J. Yee
 * Date Created     : 04/03/2012
 * Last Modified    : 07/28/2013
 * 
 */

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  Dependencies
#include <string.h>
#include "PublicLibs/CompilerSettings.h"
#include "PublicLibs/BasicLibs/Memory/AlignedMalloc.h"
#include "DigitWriter.h"
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
namespace DigitViewer{
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
DigitWriter::DigitWriter()
    : m_buffer(nullptr)
    , m_buffer_L(0)
    , m_iter_f_offset(0)
    , m_iter_b_offset(m_buffer_L)
{}
DigitWriter::~DigitWriter(){
    aligned_free(m_buffer);
}
void DigitWriter::push(const char* str, upL_t digits){
    while (digits > 0){
        //  Buffer is full
        if (m_iter_b_offset == m_buffer_L){
            make_or_flush_buffer();
        }

        upL_t block = m_buffer_L - m_iter_b_offset;
        if (block > digits)
            block = digits;

        memcpy(&m_buffer[0] + m_iter_b_offset, str, block);

        m_iter_f_offset += block;
        m_iter_b_offset += block;
        str += block;
        digits -= block;
    }
}
void DigitWriter::make_buffer(){
    upL_t buffer_size = YC_DIGITWRITER_DEFAULT_BUFFER;
    m_buffer = (char*)aligned_malloc(buffer_size, 2*sizeof(u64_t));

    //  Do this assignment last - just in case the above throws.
    m_buffer_L = buffer_size;
}
YM_NO_INLINE void DigitWriter::make_or_flush_buffer(){
    if (m_buffer_L == 0){
        make_buffer();
    }else{
        write(m_buffer, m_iter_b_offset);
        m_iter_b_offset = 0;
    }
}
void DigitWriter::flush_buffer(){
    if (m_buffer_L != 0){
        write(m_buffer, m_iter_b_offset);
        m_iter_b_offset = 0;
    }
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
}
